#!/bin/sh /etc/rc.common
# BDIX Proxy Script used for OpenWRT
# Converted to PROCD for stability

USE_PROCD=1
START=99
STOP=01

PROG=/usr/sbin/redsocks
CONFIG=/etc/bdix.conf
IPSET_NAME=bdix_whitelist
PORT=1337
INTERFACE=br-lan

start_service() {
    # Check config
    [ -e "$CONFIG" ] || return 1

    # Create IPSET if it doesn't exist
    # usage: ipset create setname hash:ip
    ipset -L $IPSET_NAME >/dev/null 2>&1 || ipset -N $IPSET_NAME hash:ip

    # Start Redsocks via PROCD
    procd_open_instance
    procd_set_param command $PROG -c $CONFIG
    procd_set_param respawn
    procd_set_param stdout 1
    procd_set_param stderr 1
    procd_close_instance

    # Firewall Rules
    iptables_init
}

stop_service() {
    iptables_flush
    # procd handles killing the process
}

reload_service() {
    stop
    start
}

iptables_init() {
    # Create chain
    iptables -t nat -N BDIX 2>/dev/null
    iptables -t nat -F BDIX

    # 1. Whitelist from IPSET (Populated by dnsmasq)
    iptables -t nat -A BDIX -m set --match-set $IPSET_NAME dst -j RETURN

    # 2. Local/Private ranges bypass
    iptables -t nat -A BDIX -d 0.0.0.0/8 -j RETURN
    iptables -t nat -A BDIX -d 10.0.0.0/8 -j RETURN
    iptables -t nat -A BDIX -d 127.0.0.0/8 -j RETURN
    iptables -t nat -A BDIX -d 169.254.0.0/16 -j RETURN
    iptables -t nat -A BDIX -d 172.16.0.0/12 -j RETURN
    iptables -t nat -A BDIX -d 192.168.0.0/16 -j RETURN
    iptables -t nat -A BDIX -d 224.0.0.0/4 -j RETURN
    iptables -t nat -A BDIX -d 240.0.0.0/4 -j RETURN

    # 3. Redirect to Redsocks
    iptables -t nat -A BDIX -p tcp -j REDIRECT --to-ports $PORT

    # 4. Apply to LAN interface (PREROUTING) checks
    # Avoid duplicate rules
    if ! iptables -t nat -C PREROUTING -i $INTERFACE -p tcp -j BDIX 2>/dev/null; then
        iptables -t nat -I PREROUTING -i $INTERFACE -p tcp -j BDIX
    fi
    
    # Allow input on port (only from LAN)
    iptables -I INPUT -i $INTERFACE -p tcp --dport $PORT -j ACCEPT
}

iptables_flush() {
    iptables -t nat -D PREROUTING -i $INTERFACE -p tcp -j BDIX 2>/dev/null
    iptables -t nat -F BDIX 2>/dev/null
    iptables -t nat -X BDIX 2>/dev/null
    iptables -D INPUT -i $INTERFACE -p tcp --dport $PORT -j ACCEPT 2>/dev/null
}
